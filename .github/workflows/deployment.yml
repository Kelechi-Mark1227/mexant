name: cicd workflow
on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: configure AWS credentials
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set default.region ${{ secrets.AWS_REGION }}

      - name: log into ECR
        run: |
         aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin 203981192956.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

      - name: build and push to ECR
        run: |
          docker build -t mexant:${{ github.run_number }} .
          docker tag mexant:${{ github.run_number }} 203981192956.dkr.ecr.us-east-1.amazonaws.com/mexant:${{ github.run_number }}
          docker push 203981192956.dkr.ecr.us-east-1.amazonaws.com/mexant:${{ github.run_number }}   
  
  update-k8s-deployment-file:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
    - name: clone-k8s-yaml repo
      env:
        GITHUB_USERNAME: ${{ secrets.GIT_USERNAME }}
        GITHUB_PASSWORD: ${{ secrets.GIT_PASSWORD }}
      run: |
        git clone https://${GITHUB_USERNAME}:${GITHUB_PASSWORD}@github.com/Kelechi-Mark1227/kubernetes-manifest.git
        cd kubernetes-manifest/meaxant-cluster
        cat deployment.yaml
        sed -i "s+203981192956.dkr.ecr.us-east-1.amazonaws.com/mexant:.*+203981192956.dkr.ecr.us-east-1.amazonaws.com/mexant:${{ github.run_number }}+g" deployment.yaml
        cat deployment.yaml
        git config user.name ${GITHUB_USERNAME}
        git config user.email karlelcena@gmail.com
        git add .
        git commit -m "updated k8s manifest to version ${{ github.run_number }}"
        git push https://${GITHUB_USERNAME}:${GITHUB_PASSWORD}@github.com/Kelechi-Mark1227/kubernetes-manifest.git HEAD:main


  # deploy-to-instance:
  #   needs: build-and-push
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: checkout code
  #       uses: actions/checkout@v4

  #     - name: configure AWS credentials
  #       run: |
  #         echo "${{ secrets.SSH_KEY }}" > my-key.pem
  #         chmod 600 my-key.pem

  #           ssh -o StrictHostKeyChecking=no -i my-key.pem -p1227 ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
  #           sudo snap install aws-cli --classic
  #           aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin 203981192956.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  #           docker push 203981192956.dkr.ecr.us-east-1.amazonaws.com/mexant:${{ github.run_number }} 
  #           docker rm -f mexant 
  #           docker run -d --name mexant -p 80:80 203981192956.dkr.ecr.us-east-1.amazonaws.com/mexant:${{ github.run_number }} 
  #         EOF